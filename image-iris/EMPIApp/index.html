<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‚£è€…ä¿¡æ¯æ³¨å†Œ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #00a99d;
            /* Blue-green background */
            text-align: center;
            color: #ffffff;
            /* White text color */
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #ffffff;
            /* Light gray background */
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #007bff;
            /* Zoho.com blue color */
        }

        input[type="text"],
        input[type="date"] {
            width: 90%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        input[type="button"] {
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        input[type="button"]:hover {
            background-color: #0056b3;
        }

        .patient-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            /* é»˜è®¤éšè—æ¨¡æ€æ¡† */
            position: fixed;
            /* å›ºå®šåœ¨è§†å£ */
            z-index: 1;
            /* ç½®äºå…¶ä»–å…ƒç´ ä¹‹ä¸Š */
            left: 0;
            top: 0;
            width: 100%;
            /* å…¨å±å®½ */
            height: 100%;
            /* å…¨å±é«˜ */
            overflow: auto;
            /* å…è®¸æ»šåŠ¨ */
            background-color: rgba(0, 0, 0, 0.4);
            /* é®ç½©å±‚èƒŒæ™¯è‰² */
        }

        /* æ¨¡æ€æ¡†å†…å®¹æ ·å¼ */
        .modal-content {
            background-color: #00a99d;
            margin: 15% auto;
            /* å‚ç›´å±…ä¸­ï¼Œæ°´å¹³å±…ä¸­ */
            padding: 20px;
            border: 1px solid #888;
            width: 100%;
            /* å®½åº¦å¯ä»¥æ˜¯å›ºå®šçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç™¾åˆ†æ¯” */
        }

        /* å…³é—­æŒ‰é’®æ ·å¼ */
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table {
            list-style-type: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        .cell {
            flex: 1;
            padding: 0 10px;
        }

        /* æ“ä½œæŒ‰é’®æ ·å¼ */
        .modal-actions {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
    </style>
    <!--<script src="./scripts/dist.js"> </script>-->
</head>

<body>
    <div class="container">
        <h1><span class="patient-icon">ğŸ‘¤</span>æ‚£è€…ä¿¡æ¯</h1>
        <form>
            <label for="stock">è¯»å–å·²å‘é‡åŒ–æ‚£è€…</label>
            <select id="stock" name="stock" onchange="loadPatientInfo()">
                <option value=""></option>
            </select>

            <label for="threhold">ç›¸ä¼¼åº¦é˜ˆå€¼(%)ï¼š</label>
            <input type="text" id="threhold" name="threhold" value="20" required />

            <label for="lastName">å§“ï¼š</label>
            <input type="text" id="lastName" name="lastName" value="å¼ " required>
            <label for="firstName">åï¼š</label>
            <input type="text" id="firstName" name="firstName" value="ä¸‰" required>

            <label for="gender">æ€§åˆ«ï¼š</label>
            <select id="gender" name="gender">
                <option value="male">ç”·æ€§</option>
                <option value="female">å¥³æ€§</option>
                <option value=""></option>
            </select>

            <label for="birthdate">å‡ºç”Ÿæ—¥æœŸï¼š</label>
            <input type="date" id="birthdate" name="birthdate" value="1990-01-01" required>

            <label for="address">ä½å€ï¼š</label>
            <input type="text" id="address" name="address" value="åŒ—äº¬å¸‚æœé˜³åŒº" required>

            <label for="phoneNumber">ç”µè¯å·ç ï¼š</label>
            <input type="text" id="phoneNumber" name="phoneNumber" value="13571072756" required>

            <label for="idNumber">èº«ä»½è¯å·ç ï¼š</label>
            <input type="text" id="idNumber" name="idNumber" value="110101199001010001" required>

            <label for="insuranceCard">åŒ»ä¿å¡å·ç ï¼š</label>
            <input type="text" id="insuranceCard" name="insuranceCard" value="1234567890" required>

            <input type="button" value="æäº¤" id="triggerButton">
        </form>
    </div>
    <!-- ä¿¡æ¯æç¤ºé¡µæ¨¡æ€æ¡† -->
    <div id="EMPIInfo" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideModal()">&times;</span>
            <span id="patInfo"></span>
            <h2>ç›¸ä¼¼æ‚£è€…æ¸…å•</h2>
            <!-- ä½¿ç”¨<ul>å®ç°çš„è¡¨æ ¼ -->
            <ul class="table" id="patList">
                <li class="row">
                    <span class="cell">èµ„æºID</span>
                    <span class="cell">æ‚£è€…ä¿¡æ¯æ‘˜è¦</span>
                    <span class="cell">ç›¸ä¼¼åº¦</span>
                </li>
            </ul>

            <!-- åˆå¹¶ã€ä¿å­˜ã€å–æ¶ˆæŒ‰é’® -->
            <div class="modal-actions">
                <!--<input type="button" value="åˆå¹¶" id="mergeBtn">-->
                <input type="button" value="ä¿å­˜" id="saveBtn" onclick="addPatient()">
                <input type="button" value="å–æ¶ˆ" id="cancelBtn" onclick="hideModal()">
            </div>
        </div>
    </div>
</body>
<script>
    const empiUrl = 'http://192.168.98.188/api/EMPI/Patient';
    const fhirEndpoint = 'http://192.168.98.188/csp/healthshare/fhirserver/fhir/r4';
    var similarPatients = [];
    var patientData;
    var patientSummary;
    //é¡µé¢åŠ è½½å®Œæˆåå…ˆè¯»å­˜é‡çš„Embeddedæ‚£è€…
    document.addEventListener('DOMContentLoaded', (event) => {
        const apiUrl = 'http://192.168.98.188/api/EMPI/PatientIds';

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // åœ¨è¿™é‡Œå¤„ç†ä½ çš„æ•°æ®ï¼Œä¾‹å¦‚å°†å…¶æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
                var idList = document.getElementById('stock');
                for (var item of data) {
                    var newOption = document.createElement("option");
                    // è®¾ç½®optionçš„æ–‡æœ¬å’Œå€¼  
                    newOption.text = item;
                    newOption.value = item;
                    // å°†æ–°çš„optionæ·»åŠ åˆ°selectä¸­  
                    idList.add(newOption);
                }
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
    });

    // è·å–æ¨¡æ€æ¡†å’ŒæŒ‰é’®å…ƒç´   
    var modal = document.getElementById("EMPIInfo");
    var span = document.getElementsByClassName("close")[0];
    document.getElementById('triggerButton').addEventListener('click', function () {
        clearTable();
        patientData = {
            Name: document.getElementById('lastName').value + document.getElementById('firstName').value,
            Gender: document.getElementById('gender').value,
            DOB: document.getElementById('birthdate').value,
            Address: document.getElementById('address').value,
            PhoneNumber: document.getElementById('phoneNumber').value,
            IdNumber: document.getElementById('idNumber').value,
            InsuranceNumber: document.getElementById('insuranceCard').value,
            Threhold: document.getElementById('threhold').value
        };
        patientSummary = patientData.Name + "," + getGenderString(patientData.Gender) + "," + patientData.DOB
            + ",åœ°å€ï¼š" + patientData.Address + ",ç”µè¯ï¼š" + patientData.PhoneNumber + ",èº«ä»½è¯å·ç ï¼š" + patientData.IdNumber + ",åŒ»ä¿å¡å·ç ï¼š" + patientData.InsuranceNumber
        console.log(patientSummary)
        // ä½¿ç”¨fetch APIå‘é€POSTè¯·æ±‚  
        fetch(empiUrl, {
            method: 'POST', // æˆ–è€… 'put'  
            headers: {
                'Content-Type': 'application/json', // å‘Šè¯‰æœåŠ¡å™¨ä½ å‘é€çš„æ˜¯JSON  
            },
            body: JSON.stringify(patientData), // ä½¿ç”¨JSON.stringify()å°†æ•°æ®è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²  
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // è§£æå“åº”ä½“ä¸ºJSON  
            })
            .then(data => {
                handleEMPIResponse(data);
                showModal();
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
        // æ˜¾ç¤ºæç¤ºé¡µ  
        //document.getElementById('modal').style.display = 'block';
    });

    // æ˜¾ç¤ºæ¨¡æ€æ¡†çš„å‡½æ•°  
    function showModal() {
        modal.style.display = "block";
    }

    // éšè—æ¨¡æ€æ¡†çš„å‡½æ•°  
    function hideModal() {
        clearTable();
        document.getElementById('patInfo').innerText = ""
        modal.style.display = "none";
    }

    function handleEMPIResponse(data) {
        var patInfoBox = document.getElementById('patInfo')
        patInfoBox.innerText = patientSummary
        for (var item of data) {
            addPatRow(item);
        }
    }

    function addPatRow(item) {
        // åˆ›å»ºä¸€ä¸ªæ–°çš„è¡Œå…ƒç´   
        var newRow = document.createElement('li');
        newRow.classList.add('row');

        // åˆ›å»ºä¸‰ä¸ªæ–°çš„åˆ—å…ƒç´   
        var newCellID = document.createElement('span');
        newCellID.classList.add('cell');
        newCellID.textContent = item.ResourceId;

        var newCellSummary = document.createElement('span');
        newCellSummary.classList.add('cell');
        newCellSummary.textContent = item.DemographicSummary;

        var newCellSimilarity = document.createElement('span');
        newCellSimilarity.classList.add('cell');
        newCellSimilarity.textContent = formatDecimalToPercent((0 + item.Similarity));

        //item.Similarity;

        // å°†æ–°çš„åˆ—å…ƒç´ æ·»åŠ åˆ°è¡Œå…ƒç´ ä¸­  
        newRow.appendChild(newCellID);
        newRow.appendChild(newCellSummary);
        newRow.appendChild(newCellSimilarity);

        // å°†æ–°çš„è¡Œå…ƒç´ æ·»åŠ åˆ°è¡¨æ ¼ä¸­  
        var table = document.querySelector('.table');
        table.appendChild(newRow);
    }

    function clearTable() {
        // è·å–<ul>å…ƒç´   
        var ul = document.getElementById('patList');

        // è·å–æ‰€æœ‰çš„<li>å…ƒç´   
        var lis = ul.getElementsByTagName('li');

        // ä»ç¬¬äºŒä¸ª<li>å¼€å§‹éå†ï¼ˆç´¢å¼•ä¸º1ï¼Œå› ä¸ºæ•°ç»„/NodeListæ˜¯ä»0å¼€å§‹çš„ï¼‰  
        for (var i = 1; i < lis.length; i++) {
            // ç§»é™¤å½“å‰<li>å…ƒç´   
            ul.removeChild(lis[i]);
        }
    }

    function formatDecimalToPercent(decimal) {
        console.log(decimal)
        // ä¹˜ä»¥100å¹¶ä¿ç•™ä¸¤ä½å°æ•°ï¼ˆå¦‚æœéœ€è¦ï¼‰  
        var percent = (decimal * 100).toFixed(2);

        // æ·»åŠ ç™¾åˆ†æ¯”ç¬¦å·  
        return percent + '%';
    }

    function getGenderString(code) {
        str = "";
        switch (code) {
            case "male":
                str = 'ç”·æ€§';
                break;
            case "female":
                str = 'å¥³æ€§';
                break;
            default:
                str = '';
                break;
        }
        return str;
    }

    function loadPatientInfo() {
        var selectElement = document.getElementById('stock');
        // è·å–è¢«é€‰ä¸­çš„optionå…ƒç´   
        var selectedOption = selectElement.options[selectElement.selectedIndex];
        // è·å–è¢«é€‰ä¸­optionçš„valueå±æ€§å€¼  
        var pid = selectedOption.value;
        // é€šè¿‡FHIRæ¥å£è·å¾—å“åº”
        var url = fhirEndpoint + "/Patient/" + pid;
        return fetch(url, {
            method: 'GET', // æˆ–è€… 'put'  
            headers: {
                'Content-Type': 'application/json', // å‘Šè¯‰æœåŠ¡å™¨ä½ å‘é€çš„æ˜¯JSON  
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // è§£æå“åº”ä½“ä¸ºJSON  
            })
            .then(data => {
                console.log(data);
                const pat = data;
                document.getElementById("lastName").value = pat.name[0].family
                document.getElementById("firstName").value = pat.name[0].given[0]
                document.getElementById("gender").value = pat.gender
                document.getElementById("birthdate").value = pat.birthDate
                document.getElementById("address").value = pat.address[0].text
                document.getElementById("phoneNumber").value = pat.telecom[0].value
                var ids = pat.identifier
                for (var item of ids) {
                    if ("èº«ä»½è¯å·ç " == item.type.text) {
                        document.getElementById("idNumber").value = item.value
                        continue;
                    }
                    if ("åŒ»ä¿å¡å·ç " == item.type.text) {
                        document.getElementById("insuranceCard").value = item.value
                        continue;
                    }
                }
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
    }

    function addPatient() {
        var patient = makePatientRes();
        console.log(JSON.stringify(patient));
        var postPatUrl = fhirEndpoint + "/Patient"
        fetch(postPatUrl, {
            method: 'POST', // æˆ–è€… 'put'  
            headers: {
                'Content-Type': 'application/fhir+json; charset=UTF-8', // å‘Šè¯‰æœåŠ¡å™¨ä½ å‘é€çš„æ˜¯JSON  
            },
            body: JSON.stringify(patient), // ä½¿ç”¨JSON.stringify()å°†æ•°æ®è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²  
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // è·å–å“åº”å¤´ä¸­çš„æŸä¸ªå­—æ®µ  
                const contentType = response.headers.get('Location');
                console.log('Content-Type:', contentType);

                // æˆ–è€…ï¼Œè·å–å“åº”å¤´ä¸­æ‰€æœ‰å­—æ®µçš„é”®  
                for (let key of response.headers.keys()) {
                    console.log(key + ': ' + response.headers.get(key));
                }
                alert("æ‚£è€…"+patient.name[0].family+patient.name[0].given[0]+"ä¿¡æ¯ä¿å­˜æˆåŠŸ")
                return response; // è§£æå“åº”ä½“ä¸ºJSON  
            })
            .then(data => {
                console.log(data);
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
    }

    function makePatientRes() {
        var patient = {
            "resourceType": "Patient",
            "address": [
                {
                    "text": document.getElementById("address").value
                }
            ],
            "gender": document.getElementById("gender").value,
            "birthDate": document.getElementById("birthdate").value,
            "identifier": [
                {
                    "type": {
                        "text": "èº«ä»½è¯å·ç "
                    },
                    "value": document.getElementById("idNumber").value
                },
                {
                    "type": {
                        "text": "åŒ»ä¿å¡å·ç "
                    },
                    "value": document.getElementById("insuranceCard").value
                }
            ],
            "name": [
                {
                    "family": document.getElementById("lastName").value,
                    "given": [
                        document.getElementById("firstName").value
                    ]
                }
            ],
            "telecom": [
                {
                    "value": document.getElementById("phoneNumber").value
                }
            ]
        };
        return patient;
    }

</script>

</html>